# 修复外键约束错误 (Foreign Key Constraint Error)

您遇到的错误非常典型：**外键冲突**。
报错信息 `violates foreign key constraint "user_preferences_user_id_fkey"` 告诉我们：尽管前端代码尝试删除了 `user_preferences` 表中的数据，但数据库里**实际上还有残留数据**，导致无法删除主账号。

这通常是因为 Supabase 的 **RLS (行级安全策略)** 阻止了前端直接删除这些记录（前端看起来成功了，但实际没删掉），或者是因为网络竞态问题。

**最稳妥的解决方案**：
既然我们已经有了后端 RPC 函数，我们应该把“清理数据”的工作也交给这个拥有管理员权限 (`security definer`) 的函数来做。这样可以无视 RLS 限制，强制清空关联数据。

## 修复计划

### 1. 升级 SQL 脚本 (`supabase_setup.sql`)
*   修改 `delete_user` 函数。
*   在删除 `auth.users` 之前，**显式执行 SQL 删除语句** 来清理 `public.user_preferences`, `public.records`, `public.circles` 表。
*   这样既实现了“级联删除 (Cascade Delete)”的效果，又不需要修改数据库表结构。

### 2. 简化前端代码 (`authService.ts`)
*   虽然前端删除也没坏处，但既然后端会强制清理，我们可以把前端的删除逻辑视为“尝试性清理”，或者保留现状作为双重保险。为了保持代码整洁，我会保留前端逻辑，但在 RPC 中增加兜底。

请运行更新后的 SQL 脚本，它将彻底解决这个问题。
